name: 'Docker Build and Push Action'
description: 'Builds and pushes a Docker image'
inputs:
  image-tag:
    description: 'Docker image tag'
    required: true
  file-path:
    description: 'Path to the target docker file'
    required: true
  repo:
    description: 'target docker repo'
    required: true
  username:
    description: 'docker hub user name'
    required: true
  auth-token:
    description: 'docker hub auth token or password'
    required: true
outputs:
  published-image:
    value: ''
    description: 'the repo:tag of the published image'
runs:
  using: 'composite'
  steps:
    - name: Get branch name
      id: get_git_branch
      run: |
        echo "branch=${GITHUB_REF#refs/heads/}" 
        echo "::set-output name=branch::$(echo ${GITHUB_REF#refs/heads/})"
      shell: bash

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ inputs.username }}
        password: ${{ inputs.auth-token }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ${{ inputs.file-path }}
        push: true
        tags: ${{ inputs.repo }}:${{ inputs.image-tag }}-${{ steps.get_git_branch.outputs.branch }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Output image tag
      shell: bash
      run : |
        echo "::set-output name=published-image::$(echo ${{ inputs.repo }}:${{ inputs.image-tag }}-${{ steps.get_git_branch.outputs.branch }})"